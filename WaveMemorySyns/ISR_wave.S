/*
 * PWM out PIN3
 * 
 */
#include <avr/io.h>
#include <avr/interrupt.h>
#include "envtone_def.h"

.extern memtone
.extern wave_tbl


//#define USE_DAC 
#define TABLE_SIZE_MASK 0x3f
#define MAX_TONE  4


/* offset from struct head */
#define SIN_POSL 0
#define SIN_POSH 1
#define SIN_STEPL 2
#define SIN_STEPH 3
#define VOL     4
#define ENV_STATE 5
#define ENV_CNT   6
#define ATK   7
#define DECY  8
#define SUL   9
#define SUS   10
#define REL   11
#define LEVEL 12
#define WAVE_TBLL 13
#define WAVE_TBLH 14

#define SIZEOF_MEMTONE 15

#define F_ATK  1
#define F_DECY 2
#define F_SUS  3
#define F_REL  4



.section .data
wait_cnt: .dc.b  0        //エンベロープのウェイト用カウンタ


.section .text



.global TIMER1_COMPA_vect
TIMER1_COMPA_vect:
.func
  cli
  push r0
  push r1
  in r0,_SFR_IO_ADDR(SREG)
  push r0
  push XL
  push XH
  push YL
  push YH
  push ZL
  push ZH
  push r16
  push r17
  push r18
  push r19
  


#ifdef USE_DAC
  cbi 0x03, 0x02
  ldi ZL, 0x36
  out _SFR_IO_ADDR(SPDR), ZL 
#endif
 ldi XL,MAX_TONE - 1     ;loop conter
 clr r18

  
  lds r17,wait_cnt
#ifdef USE_32KHZ
  subi r17,32
#else
  subi r17,64
#endif
  sts wait_cnt,r17


loop:
  ldi XH,SIZEOF_MEMTONE     
  mul XH,XL
  movw YL,r0
  subi YL,lo8(-(memtone))   //Y index of memtone head
  sbci YH,hi8(-(memtone))

  ldd ZL, Y+SIN_POSH     //Zレジスタを逆に使い　読み出しポインタ加算
  ldd ZH, Y+SIN_POSL
  ldd r16,Y+SIN_STEPH
  ldd r17,Y+SIN_STEPL
  add ZH,r17
  adc ZL,r16
  andi ZL,TABLE_SIZE_MASK
  std Y + SIN_POSH, ZL
  std Y + SIN_POSL, ZH

  clr ZH                  //Read sin table from tone pointer
//  subi ZL, lo8(-(wave_tbl))
//  sbci ZH, hi8(-(wave_tbl))
//  ld r19, Z
    ldd r16,Y+WAVE_TBLL
    ldd r17,Y+WAVE_TBLH
    add ZL,r16
    adc ZH,r17
    //ld r19,Z
    lpm r19,Z         //波形をPROGMEMで置いている場合
    
  // volume
  subi r19,(-31)
  ldi ZL,63
  ldd  r16, Y + VOL
  muls r16,ZL
  movw ZL,r0
  clr r0
  add ZL,r19
  adc ZH,r0
  subi ZL,lo8(-(conv_vol ))
  sbci ZH,hi8(-(conv_vol ))
  lpm r19,Z


//------- envelope   --- r16  level  r17 env_cnt  ----------------------
  ldd r16,Y + LEVEL
  lds XH,wait_cnt
   cpi XH,(0)
   breq DO_ENVCHG
   jmp ENV_LEVEL   


  
DO_ENVCHG:

  ldd r17,Y + ENV_CNT
   
  ldd XH,Y + ENV_STATE    //memtone[XL].env_state
  
  cpi XH,F_ATK
  breq ATK_FASE
  
  cpi XH,F_DECY
  breq DECY_FASE
  
  cpi XH,F_SUS
  breq SUS_FASE
  
  cpi XH,F_REL
  breq REL_FASE
  
  jmp ENV_LEVEL

  
ATK_FASE:
  ldd XH,Y+ATK
  sub r17,XH
  brcs DO_ATK_INC
  std Y+ ENV_CNT,r17
  jmp ENV_LEVEL

DO_ATK_INC:
  ldi r17,250
  std Y+ENV_CNT,r17
  inc r16
  std Y+LEVEL,r16
  cpi r16,(31)
  brne CONTINUE_ATK
  ldi r17,F_DECY       // set decay fase
  std Y+ENV_STATE,r17
CONTINUE_ATK:
  jmp ENV_LEVEL
  
  
DECY_FASE:
  ldd XH,Y+DECY
  sub r17,XH
  brcs DO_DECY_DEC
  std Y+ENV_CNT,r17
  jmp ENV_LEVEL

DO_DECY_DEC:
  ldi r17,250
  std Y+ENV_CNT,r17
  dec r16
  std Y+LEVEL,r16
  ldd XH,Y+SUL   //compare sustain level
  cp r16,XH
  brne CONTINUE_DECY
  ldi r17,F_SUS         //set sustain fase
  std Y+ENV_STATE,r17
CONTINUE_DECY:
  jmp ENV_LEVEL


SUS_FASE:
  ldd XH,Y+SUS
  sub r17,XH
  brcs DO_SUS_DEC
  std Y+ENV_CNT,r17
  jmp ENV_LEVEL

DO_SUS_DEC:
  ldi r17,250
  std Y+ENV_CNT,r17
  cpi r16,(0)
  breq CONTINUE_SUS 
  dec r16
  std Y+LEVEL,r16
  jmp ENV_LEVEL
CONTINUE_SUS:
  clr r17
  std Y+SIN_STEPL,r17
  std Y+SIN_STEPH,r17
   jmp ENV_LEVEL


REL_FASE:

  ldd XH,Y+REL
  sub r17,XH
  brcs DO_REL_DEC
  std Y+ENV_CNT,r17
  jmp ENV_LEVEL

DO_REL_DEC:
  ldi r17,250
  std Y+ENV_CNT,r17
  cpi r16,(0)
  breq STOP_TONE 
  dec r16
  std Y+LEVEL,r16
  sbi 11,2
  jmp ENV_LEVEL
STOP_TONE:
  clr r17
  std Y+SIN_STEPL,r17
  std Y+SIN_STEPH,r17 
  jmp ENV_LEVEL


 ENV_LEVEL:  

   subi r19,(-31);
  ldi ZL,63
  mul r16,ZL
  movw ZL,r0
  clr r0
  add ZL,r19
  adc ZH,r0
  subi ZL,lo8(-(conv_vol))
  sbci ZH,hi8(-(conv_vol))
  lpm r19,Z 
  


  add r18,r19

  subi XL,(1)
  brcs  endloop
  jmp loop
endloop:
   
  subi r18, (-128)
  
 #ifdef USE_DAC
  out _SFR_IO_ADDR(SPDR), r18
 #endif
  sts OCR2B, r18

.rept 90
nop
.endr


  pop r19
  pop r18
  pop r17
  pop r16
  pop ZH
  pop ZL
  pop YH
  pop YL
  pop XH
  pop XL
  pop r0
  out _SFR_IO_ADDR(SREG), r0
  pop r1
  pop r0
#ifdef USE_DAC  
  sbi 0x03, 0x02;
#endif  
  sei
  reti

.endfunc


// 除算テーブル
.global conv_vol
conv_vol: 
.dc.b    0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0
.dc.b  -1, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1
.dc.b  -2, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  2
.dc.b  -3, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  3
.dc.b  -4, -3, -3, -3, -3, -3, -3, -3, -2, -2, -2, -2, -2, -2, -2, -2, -1, -1, -1, -1, -1, -1, -1, -1, -0, -0, -0, -0, -0, -0, -0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  1,  1,  1,  1,  1,  1,  2,  2,  2,  2,  2,  2,  2,  2,  3,  3,  3,  3,  3,  3,  3,  4
.dc.b  -5, -4, -4, -4, -4, -4, -4, -3, -3, -3, -3, -3, -3, -2, -2, -2, -2, -2, -2, -1, -1, -1, -1, -1, -1, -0, -0, -0, -0, -0, -0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  1,  1,  1,  1,  2,  2,  2,  2,  2,  2,  3,  3,  3,  3,  3,  3,  4,  4,  4,  4,  4,  4,  5
.dc.b  -6, -5, -5, -5, -5, -5, -4, -4, -4, -4, -4, -3, -3, -3, -3, -3, -2, -2, -2, -2, -2, -1, -1, -1, -1, -1, -0, -0, -0, -0, -0,  0,  0,  0,  0,  0,  0,  1,  1,  1,  1,  1,  2,  2,  2,  2,  2,  3,  3,  3,  3,  3,  4,  4,  4,  4,  4,  5,  5,  5,  5,  5,  6
.dc.b  -7, -6, -6, -6, -6, -5, -5, -5, -5, -4, -4, -4, -4, -4, -3, -3, -3, -3, -2, -2, -2, -2, -2, -1, -1, -1, -1, -0, -0, -0, -0,  0,  0,  0,  0,  0,  1,  1,  1,  1,  2,  2,  2,  2,  2,  3,  3,  3,  3,  4,  4,  4,  4,  4,  5,  5,  5,  5,  6,  6,  6,  6,  7
.dc.b  -8, -7, -7, -7, -6, -6, -6, -6, -5, -5, -5, -5, -4, -4, -4, -4, -3, -3, -3, -3, -2, -2, -2, -2, -1, -1, -1, -1, -0, -0, -0,  0,  0,  0,  0,  1,  1,  1,  1,  2,  2,  2,  2,  3,  3,  3,  3,  4,  4,  4,  4,  5,  5,  5,  5,  6,  6,  6,  6,  7,  7,  7,  8
.dc.b  -9, -8, -8, -8, -7, -7, -7, -6, -6, -6, -6, -5, -5, -5, -4, -4, -4, -4, -3, -3, -3, -2, -2, -2, -2, -1, -1, -1, -0, -0, -0,  0,  0,  0,  0,  1,  1,  1,  2,  2,  2,  2,  3,  3,  3,  4,  4,  4,  4,  5,  5,  5,  6,  6,  6,  6,  7,  7,  7,  8,  8,  8,  9
.dc.b -10, -9, -9, -9, -8, -8, -8, -7, -7, -7, -6, -6, -6, -5, -5, -5, -4, -4, -4, -3, -3, -3, -2, -2, -2, -1, -1, -1, -0, -0, -0,  0,  0,  0,  0,  1,  1,  1,  2,  2,  2,  3,  3,  3,  4,  4,  4,  5,  5,  5,  6,  6,  6,  7,  7,  7,  8,  8,  8,  9,  9,  9, 10
.dc.b -11,-10,-10, -9, -9, -9, -8, -8, -8, -7, -7, -7, -6, -6, -6, -5, -5, -4, -4, -4, -3, -3, -3, -2, -2, -2, -1, -1, -1, -0, -0,  0,  0,  0,  1,  1,  1,  2,  2,  2,  3,  3,  3,  4,  4,  4,  5,  5,  6,  6,  6,  7,  7,  7,  8,  8,  8,  9,  9,  9, 10, 10, 11
.dc.b -12,-11,-11,-10,-10,-10, -9, -9, -8, -8, -8, -7, -7, -6, -6, -6, -5, -5, -5, -4, -4, -3, -3, -3, -2, -2, -1, -1, -1, -0, -0,  0,  0,  0,  1,  1,  1,  2,  2,  3,  3,  3,  4,  4,  5,  5,  5,  6,  6,  6,  7,  7,  8,  8,  8,  9,  9, 10, 10, 10, 11, 11, 12
.dc.b -13,-12,-12,-11,-11,-10,-10,-10, -9, -9, -8, -8, -7, -7, -7, -6, -6, -5, -5, -5, -4, -4, -3, -3, -2, -2, -2, -1, -1, -0, -0,  0,  0,  0,  1,  1,  2,  2,  2,  3,  3,  4,  4,  5,  5,  5,  6,  6,  7,  7,  7,  8,  8,  9,  9, 10, 10, 10, 11, 11, 12, 12, 13
.dc.b -14,-13,-13,-12,-12,-11,-11,-10,-10, -9, -9, -9, -8, -8, -7, -7, -6, -6, -5, -5, -4, -4, -4, -3, -3, -2, -2, -1, -1, -0, -0,  0,  0,  0,  1,  1,  2,  2,  3,  3,  4,  4,  4,  5,  5,  6,  6,  7,  7,  8,  8,  9,  9,  9, 10, 10, 11, 11, 12, 12, 13, 13, 14
.dc.b -15,-14,-14,-13,-13,-12,-12,-11,-11,-10,-10, -9, -9, -8, -8, -7, -7, -6, -6, -5, -5, -4, -4, -3, -3, -2, -2, -1, -1, -0, -0,  0,  0,  0,  1,  1,  2,  2,  3,  3,  4,  4,  5,  5,  6,  6,  7,  7,  8,  8,  9,  9, 10, 10, 11, 11, 12, 12, 13, 13, 14, 14, 15
.dc.b -16,-15,-14,-14,-13,-13,-12,-12,-11,-11,-10,-10, -9, -9, -8, -8, -7, -7, -6, -6, -5, -5, -4, -4, -3, -3, -2, -2, -1, -1, -0,  0,  0,  1,  1,  2,  2,  3,  3,  4,  4,  5,  5,  6,  6,  7,  7,  8,  8,  9,  9, 10, 10, 11, 11, 12, 12, 13, 13, 14, 14, 15, 16
.dc.b -17,-16,-15,-15,-14,-14,-13,-13,-12,-12,-11,-10,-10, -9, -9, -8, -8, -7, -7, -6, -6, -5, -4, -4, -3, -3, -2, -2, -1, -1, -0,  0,  0,  1,  1,  2,  2,  3,  3,  4,  4,  5,  6,  6,  7,  7,  8,  8,  9,  9, 10, 10, 11, 12, 12, 13, 13, 14, 14, 15, 15, 16, 17
.dc.b -18,-17,-16,-16,-15,-15,-14,-13,-13,-12,-12,-11,-11,-10, -9, -9, -8, -8, -7, -6, -6, -5, -5, -4, -4, -3, -2, -2, -1, -1, -0,  0,  0,  1,  1,  2,  2,  3,  4,  4,  5,  5,  6,  6,  7,  8,  8,  9,  9, 10, 11, 11, 12, 12, 13, 13, 14, 15, 15, 16, 16, 17, 18
.dc.b -19,-18,-17,-17,-16,-15,-15,-14,-14,-13,-12,-12,-11,-11,-10, -9, -9, -8, -7, -7, -6, -6, -5, -4, -4, -3, -3, -2, -1, -1, -0,  0,  0,  1,  1,  2,  3,  3,  4,  4,  5,  6,  6,  7,  7,  8,  9,  9, 10, 11, 11, 12, 12, 13, 14, 14, 15, 15, 16, 17, 17, 18, 19
.dc.b -20,-19,-18,-18,-17,-16,-16,-15,-14,-14,-13,-12,-12,-11,-10,-10, -9, -9, -8, -7, -7, -6, -5, -5, -4, -3, -3, -2, -1, -1, -0,  0,  0,  1,  1,  2,  3,  3,  4,  5,  5,  6,  7,  7,  8,  9,  9, 10, 10, 11, 12, 12, 13, 14, 14, 15, 16, 16, 17, 18, 18, 19, 20
.dc.b -21,-20,-19,-18,-18,-17,-16,-16,-15,-14,-14,-13,-12,-12,-11,-10,-10, -9, -8, -8, -7, -6, -6, -5, -4, -4, -3, -2, -2, -1, -0,  0,  0,  1,  2,  2,  3,  4,  4,  5,  6,  6,  7,  8,  8,  9, 10, 10, 11, 12, 12, 13, 14, 14, 15, 16, 16, 17, 18, 18, 19, 20, 21
.dc.b -22,-21,-20,-19,-19,-18,-17,-17,-16,-15,-14,-14,-13,-12,-12,-11,-10, -9, -9, -8, -7, -7, -6, -5, -4, -4, -3, -2, -2, -1, -0,  0,  0,  1,  2,  2,  3,  4,  4,  5,  6,  7,  7,  8,  9,  9, 10, 11, 12, 12, 13, 14, 14, 15, 16, 17, 17, 18, 19, 19, 20, 21, 22
.dc.b -23,-22,-21,-20,-20,-19,-18,-17,-17,-16,-15,-14,-14,-13,-12,-11,-11,-10, -9, -8, -8, -7, -6, -5, -5, -4, -3, -2, -2, -1, -0,  0,  0,  1,  2,  2,  3,  4,  5,  5,  6,  7,  8,  8,  9, 10, 11, 11, 12, 13, 14, 14, 15, 16, 17, 17, 18, 19, 20, 20, 21, 22, 23
.dc.b -24,-23,-22,-21,-20,-20,-19,-18,-17,-17,-16,-15,-14,-13,-13,-12,-11,-10,-10, -9, -8, -7, -6, -6, -5, -4, -3, -3, -2, -1, -0,  0,  0,  1,  2,  3,  3,  4,  5,  6,  6,  7,  8,  9, 10, 10, 11, 12, 13, 13, 14, 15, 16, 17, 17, 18, 19, 20, 20, 21, 22, 23, 24
.dc.b -25,-24,-23,-22,-21,-20,-20,-19,-18,-17,-16,-16,-15,-14,-13,-12,-12,-11,-10, -9, -8, -8, -7, -6, -5, -4, -4, -3, -2, -1, -0,  0,  0,  1,  2,  3,  4,  4,  5,  6,  7,  8,  8,  9, 10, 11, 12, 12, 13, 14, 15, 16, 16, 17, 18, 19, 20, 20, 21, 22, 23, 24, 25
.dc.b -26,-25,-24,-23,-22,-21,-20,-20,-19,-18,-17,-16,-15,-15,-14,-13,-12,-11,-10,-10, -9, -8, -7, -6, -5, -5, -4, -3, -2, -1, -0,  0,  0,  1,  2,  3,  4,  5,  5,  6,  7,  8,  9, 10, 10, 11, 12, 13, 14, 15, 15, 16, 17, 18, 19, 20, 20, 21, 22, 23, 24, 25, 26
.dc.b -27,-26,-25,-24,-23,-22,-21,-20,-20,-19,-18,-17,-16,-15,-14,-13,-13,-12,-11,-10, -9, -8, -7, -6, -6, -5, -4, -3, -2, -1, -0,  0,  0,  1,  2,  3,  4,  5,  6,  6,  7,  8,  9, 10, 11, 12, 13, 13, 14, 15, 16, 17, 18, 19, 20, 20, 21, 22, 23, 24, 25, 26, 27
.dc.b -28,-27,-26,-25,-24,-23,-22,-21,-20,-19,-18,-18,-17,-16,-15,-14,-13,-12,-11,-10, -9, -9, -8, -7, -6, -5, -4, -3, -2, -1, -0,  0,  0,  1,  2,  3,  4,  5,  6,  7,  8,  9,  9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28
.dc.b -29,-28,-27,-26,-25,-24,-23,-22,-21,-20,-19,-18,-17,-16,-15,-14,-14,-13,-12,-11,-10, -9, -8, -7, -6, -5, -4, -3, -2, -1, -0,  0,  0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29
.dc.b -30,-29,-28,-27,-26,-25,-24,-23,-22,-21,-20,-19,-18,-17,-16,-15,-14,-13,-12,-11,-10, -9, -8, -7, -6, -5, -4, -3, -2, -1, -0,  0,  0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30
.dc.b -31,-30,-29,-28,-27,-26,-25,-24,-23,-22,-21,-20,-19,-18,-17,-16,-15,-14,-13,-12,-11,-10, -9, -8, -7, -6, -5, -4, -3, -2, -1,  0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31






